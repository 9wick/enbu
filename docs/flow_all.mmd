flowchart TD

    subgraph packages["packages"]
        subgraph packages_core["core"]
            subgraph packages_core_src["src"]
                executeFlow_7["executeFlow (+3)<br/><small>ResultAsync&lt;FlowResult, AgentB...</small>"]
                buildFailedFlowResult_10["buildFailedFlowResult<br/><small>FailedFlowResult</small>"]
                executeAllSteps_12["executeAllSteps (+1)<br/><small>Promise&lt;ExecuteAllStepsResult&gt;</small>"]
                executeStep_14["executeStep (+1)<br/><small>Promise&lt;StepResult&gt;</small>"]
                getErrorMessage_18["getErrorMessage (+1) (+1)<br/><small>string</small>"]
                processSelectorWait_58["processSelectorWait (+10)<br/><small>ResultAsync&lt;ResolvedCommand, S...</small>"]
                extractSelectorSpecOrFail_59["extractSelectorSpecOrFail<br/><small>ResultAsync&lt;SelectorSpec, Sele...</small>"]
                extractSelectorSpec_60["extractSelectorSpec<br/><small>ExtractSelectorResult</small>"]
                processDirectOrWaitSelector_61["processDirectOrWaitSelector (+2)<br/><small>ResultAsync&lt;ResolvedCommand, S...</small>"]
                processWaitableSelector_63["processWaitableSelector (+1)<br/><small>ResultAsync&lt;ResolvedCommand, S...</small>"]
                waitForSelector_65["waitForSelector<br/><small>ResultAsync&lt;WaitResult, AgentB...</small>"]
                waitForTextAndResolveRef_66["waitForTextAndResolveRef (+1)<br/><small>ResultAsync&lt;string & Brand&lt;'Re...</small>"]
                waitUntil_70["waitUntil (+1)<br/><small>ResultAsync&lt;T, AgentBrowserErr...</small>"]
                waitForXpathSelector_77["waitForXpathSelector<br/><small>ResultAsync&lt;true, AgentBrowser...</small>"]
                createVisibilityCheckFunc_78["createVisibilityCheckFunc<br/><small>() =&gt; ResultAsync&lt;CheckResult&lt;...</small>"]
                waitForCssSelector_79["waitForCssSelector<br/><small>ResultAsync&lt;true, AgentBrowser...</small>"]
                extractWaitableSelectorSpecOrFail_81["extractWaitableSelectorSpecOrFail<br/><small>ResultAsync&lt;WaitableSelectorSp...</small>"]
                executeResolvedCommand_23["executeResolvedCommand (+5) (+1)<br/><small>ResultAsync&lt;CommandResult, Exe...</small>"]
                handleAssertChecked_24["handleAssertChecked (+1)<br/><small>ResultAsync&lt;CommandResult, Exe...</small>"]
                getSelectorForErrorMessage_25["getSelectorForErrorMessage<br/><small>string</small>"]
                getSelectorString_26["getSelectorString<br/><small>string</small>"]
                resolveCliSelector_28["resolveCliSelector<br/><small>ResultAsync&lt;CliSelector, Agent...</small>"]
                handleAssertEnabled_29["handleAssertEnabled (+1)<br/><small>ResultAsync&lt;CommandResult, Exe...</small>"]
                handleAssertNotVisible_31["handleAssertNotVisible<br/><small>ResultAsync&lt;CommandResult, Exe...</small>"]
                isTextSelector_32["isTextSelector<br/><small>boolean</small>"]
                handleTextSelectorNotVisible_33["handleTextSelectorNotVisible (+1)<br/><small>ResultAsync&lt;CommandResult, Exe...</small>"]
                waitForPageStable_35["waitForPageStable<br/><small>ResultAsync&lt;undefined, AgentBr...</small>"]
                getAndCheckNotVisible_36["getAndCheckNotVisible (+1)<br/><small>ResultAsync&lt;CommandResult, Exe...</small>"]
                handleAssertVisible_38["handleAssertVisible (+1)<br/><small>ResultAsync&lt;CommandResult, Exe...</small>"]
                waitForElement_40["waitForElement<br/><small>ResultAsync&lt;undefined, AgentBr...</small>"]
                getAndCheckVisibility_41["getAndCheckVisibility (+1)<br/><small>ResultAsync&lt;CommandResult, Exe...</small>"]
                handleScrollIntoView_47["handleScrollIntoView (+1)<br/><small>ResultAsync&lt;CommandResult, Exe...</small>"]
                handleCssOrRefScrollIntoView_49["handleCssOrRefScrollIntoView<br/><small>ResultAsync&lt;CommandResult, Exe...</small>"]
                handleSelect_51["handleSelect<br/><small>ResultAsync&lt;CommandResult, Age...</small>"]
                handleHover_52["handleHover<br/><small>ResultAsync&lt;CommandResult, Age...</small>"]
                handleFill_54["handleFill<br/><small>ResultAsync&lt;CommandResult, Age...</small>"]
                handleType_55["handleType<br/><small>ResultAsync&lt;CommandResult, Age...</small>"]
                handleClick_56["handleClick<br/><small>ResultAsync&lt;CommandResult, Age...</small>"]
                runFlows_0["runFlows (+2)<br/><small>ResultAsync&lt;RunFlowsOutput, Or...</small>"]
                executeAllFlows_1["executeAllFlows<br/><small>Promise&lt;RunFlowsOutput&gt;</small>"]
                executeAllFlowsParallel_2["executeAllFlowsParallel<br/><small>Promise&lt;RunFlowsOutput&gt;</small>"]
                executeSingleFlow_3["executeSingleFlow (+4)<br/><small>Promise&lt;FlowRunSummary&gt;</small>"]
                executeAllFlowsSequential_93["executeAllFlowsSequential<br/><small>Promise&lt;RunFlowsOutput&gt;</small>"]
                loadAllFlows_94["loadAllFlows<br/><small>ResultAsync&lt;readonly Flow(), O...</small>"]
                loadSingleFlow_95["loadSingleFlow (+1)<br/><small>ResultAsync&lt;Flow, Orchestrator...</small>"]
                parseFlowYaml_96["parseFlowYaml (+1)<br/><small>Result&lt;Flow, ParseError&gt;</small>"]
                resolveEnvVariables_97["resolveEnvVariables (+1)<br/><small>Result&lt;RawFlowData, ParseError...</small>"]
                resolveStepVariables_99["resolveStepVariables<br/><small>Result&lt;unknown, ParseError&gt;</small>"]
                isRecord_100["isRecord<br/><small>boolean</small>"]
                resolveObjectVariables_101["resolveObjectVariables (+1)<br/><small>Result&lt;void, ParseError&gt;</small>"]
                buildRawFlowData_103["buildRawFlowData (+1)<br/><small>RawFlowData</small>"]
                extractEnvFromRoot_104["extractEnvFromRoot (+1)<br/><small>Readonly&lt;Record&lt;string, string...</small>"]
                isRecord_105["isRecord<br/><small>boolean</small>"]
                validateRootStructure_108["validateRootStructure<br/><small>Result&lt;Record&lt;string, unknown&gt;...</small>"]
                buildFlow_110["buildFlow<br/><small>Result&lt;Flow, ParseError&gt;</small>"]
                validateCommands_111["validateCommands (+1)<br/><small>Result&lt;readonly Command(), Par...</small>"]
                validateAllCommands_112["validateAllCommands<br/><small>Result&lt;Command(), ParseError&gt;</small>"]
                reduceValidateCommand_113["reduceValidateCommand<br/><small>Result&lt;Command(), ParseError&gt;</small>"]
                appendValidatedCommand_114["appendValidatedCommand<br/><small>Result&lt;Command(), ParseError&gt;</small>"]
                validateCommand_115["validateCommand<br/><small>Result&lt;Command, ParseError&gt;</small>"]
            end

        end

    end

    %% Edges (Data Flow: 往路→ / 復路←)
    executeFlow_7 -->|"?"| buildFailedFlowResult_10
    buildFailedFlowResult_10 -.->|"FailedFlowResult"| executeFlow_7
    executeStep_14 -->|"?"| getErrorMessage_18
    getErrorMessage_18 -.->|"string"| executeStep_14
    getSelectorForErrorMessage_25 -->|"ResolvedSelectorSpec /..."| getSelectorString_26
    getSelectorString_26 -.->|"string"| getSelectorForErrorMessage_25
    handleAssertChecked_24 -->|"ResolvedAssertCheckedC..."| getSelectorForErrorMessage_25
    getSelectorForErrorMessage_25 -.->|"string"| handleAssertChecked_24
    handleAssertChecked_24 -->|"ResolvedAssertCheckedC..."| resolveCliSelector_28
    resolveCliSelector_28 -.->|"CliSelector"| handleAssertChecked_24
    executeResolvedCommand_23 -->|"?"| handleAssertChecked_24
    handleAssertChecked_24 -.->|"CommandResult"| executeResolvedCommand_23
    handleAssertEnabled_29 -->|"ResolvedAssertEnabledC..."| getSelectorForErrorMessage_25
    getSelectorForErrorMessage_25 -.->|"string"| handleAssertEnabled_29
    handleAssertEnabled_29 -->|"ResolvedAssertEnabledC..."| resolveCliSelector_28
    resolveCliSelector_28 -.->|"CliSelector"| handleAssertEnabled_29
    executeResolvedCommand_23 -->|"?"| handleAssertEnabled_29
    handleAssertEnabled_29 -.->|"CommandResult"| executeResolvedCommand_23
    handleAssertNotVisible_31 -->|"ResolvedAssertNotVisib..."| getSelectorString_26
    getSelectorString_26 -.->|"string"| handleAssertNotVisible_31
    handleAssertNotVisible_31 -->|"ResolvedAssertNotVisib..."| isTextSelector_32
    isTextSelector_32 -.->|"boolean"| handleAssertNotVisible_31
    handleTextSelectorNotVisible_33 -->|"ExecutionContext"| waitForPageStable_35
    waitForPageStable_35 -.->|"undefined"| handleTextSelectorNotVisible_33
    handleAssertNotVisible_31 -->|"string"| handleTextSelectorNotVisible_33
    handleTextSelectorNotVisible_33 -.->|"CommandResult"| handleAssertNotVisible_31
    getAndCheckNotVisible_36 -->|"?"| getSelectorForErrorMessage_25
    getSelectorForErrorMessage_25 -.->|"string"| getAndCheckNotVisible_36
    getAndCheckNotVisible_36 -->|"ResolvedSelectorSpec"| resolveCliSelector_28
    resolveCliSelector_28 -.->|"CliSelector"| getAndCheckNotVisible_36
    handleAssertNotVisible_31 -->|"?"| getAndCheckNotVisible_36
    getAndCheckNotVisible_36 -.->|"CommandResult"| handleAssertNotVisible_31
    handleAssertNotVisible_31 -->|"ExecutionContext"| waitForPageStable_35
    waitForPageStable_35 -.->|"undefined"| handleAssertNotVisible_31
    executeResolvedCommand_23 -->|"?"| handleAssertNotVisible_31
    handleAssertNotVisible_31 -.->|"CommandResult"| executeResolvedCommand_23
    handleAssertVisible_38 -->|"ResolvedAssertVisibleC..."| getSelectorString_26
    getSelectorString_26 -.->|"string"| handleAssertVisible_38
    handleAssertVisible_38 -->|"ResolvedAssertVisibleC..."| isTextSelector_32
    isTextSelector_32 -.->|"boolean"| handleAssertVisible_38
    waitForElement_40 -->|"ResolvedSelectorSpec"| isTextSelector_32
    isTextSelector_32 -.->|"boolean"| waitForElement_40
    waitForElement_40 -->|"ResolvedSelectorSpec"| getSelectorString_26
    getSelectorString_26 -.->|"string"| waitForElement_40
    waitForElement_40 -->|"ResolvedSelectorSpec"| resolveCliSelector_28
    resolveCliSelector_28 -.->|"CliSelector"| waitForElement_40
    handleAssertVisible_38 -->|"ResolvedAssertVisibleC..."| waitForElement_40
    waitForElement_40 -.->|"undefined"| handleAssertVisible_38
    getAndCheckVisibility_41 -->|"?"| getSelectorForErrorMessage_25
    getSelectorForErrorMessage_25 -.->|"string"| getAndCheckVisibility_41
    getAndCheckVisibility_41 -->|"ResolvedSelectorSpec"| resolveCliSelector_28
    resolveCliSelector_28 -.->|"CliSelector"| getAndCheckVisibility_41
    handleAssertVisible_38 -->|"?"| getAndCheckVisibility_41
    getAndCheckVisibility_41 -.->|"CommandResult"| handleAssertVisible_38
    executeResolvedCommand_23 -->|"?"| handleAssertVisible_38
    handleAssertVisible_38 -.->|"CommandResult"| executeResolvedCommand_23
    handleScrollIntoView_47 -->|"ResolvedScrollIntoView..."| getSelectorString_26
    getSelectorString_26 -.->|"string"| handleScrollIntoView_47
    handleScrollIntoView_47 -->|"ResolvedScrollIntoView..."| isTextSelector_32
    isTextSelector_32 -.->|"boolean"| handleScrollIntoView_47
    handleCssOrRefScrollIntoView_49 -->|"ResolvedScrollIntoView..."| resolveCliSelector_28
    resolveCliSelector_28 -.->|"CliSelector"| handleCssOrRefScrollIntoView_49
    handleScrollIntoView_47 -->|"ResolvedScrollIntoView..."| handleCssOrRefScrollIntoView_49
    handleCssOrRefScrollIntoView_49 -.->|"CommandResult"| handleScrollIntoView_47
    executeResolvedCommand_23 -->|"?"| handleScrollIntoView_47
    handleScrollIntoView_47 -.->|"CommandResult"| executeResolvedCommand_23
    handleSelect_51 -->|"ResolvedSelectCommand"| resolveCliSelector_28
    resolveCliSelector_28 -.->|"CliSelector"| handleSelect_51
    executeResolvedCommand_23 -->|"?"| handleSelect_51
    handleSelect_51 -.->|"CommandResult"| executeResolvedCommand_23
    handleHover_52 -->|"ResolvedHoverCommand"| resolveCliSelector_28
    resolveCliSelector_28 -.->|"CliSelector"| handleHover_52
    executeResolvedCommand_23 -->|"?"| handleHover_52
    handleHover_52 -.->|"CommandResult"| executeResolvedCommand_23
    handleFill_54 -->|"ResolvedFillCommand"| resolveCliSelector_28
    resolveCliSelector_28 -.->|"CliSelector"| handleFill_54
    executeResolvedCommand_23 -->|"?"| handleFill_54
    handleFill_54 -.->|"CommandResult"| executeResolvedCommand_23
    handleType_55 -->|"ResolvedTypeCommand"| resolveCliSelector_28
    resolveCliSelector_28 -.->|"CliSelector"| handleType_55
    executeResolvedCommand_23 -->|"?"| handleType_55
    handleType_55 -.->|"CommandResult"| executeResolvedCommand_23
    handleClick_56 -->|"ResolvedClickCommand"| resolveCliSelector_28
    resolveCliSelector_28 -.->|"CliSelector"| handleClick_56
    executeResolvedCommand_23 -->|"?"| handleClick_56
    handleClick_56 -.->|"CommandResult"| executeResolvedCommand_23
    executeStep_14 -->|"?"| executeResolvedCommand_23
    executeResolvedCommand_23 -.->|"CommandResult"| executeStep_14
    extractSelectorSpecOrFail_59 -->|"Command"| extractSelectorSpec_60
    extractSelectorSpec_60 -.->|"ExtractSelectorResult"| extractSelectorSpecOrFail_59
    processSelectorWait_58 -->|"?"| extractSelectorSpecOrFail_59
    extractSelectorSpecOrFail_59 -.->|"SelectorSpec"| processSelectorWait_58
    waitForTextAndResolveRef_66 -->|"() =&gt; ResultAsync&lt;Chec..."| waitUntil_70
    waitUntil_70 -.->|"T"| waitForTextAndResolveRef_66
    waitForSelector_65 -->|"?"| waitForTextAndResolveRef_66
    waitForTextAndResolveRef_66 -.->|"string & Brand&lt;'RefSel..."| waitForSelector_65
    waitForXpathSelector_77 -->|"string & Brand&lt;'CliXpa..."| createVisibilityCheckFunc_78
    createVisibilityCheckFunc_78 -.->|"CheckResult&lt;true"| waitForXpathSelector_77
    waitForXpathSelector_77 -->|"() =&gt; ResultAsync&lt;Chec..."| waitUntil_70
    waitUntil_70 -.->|"T"| waitForXpathSelector_77
    waitForSelector_65 -->|"?"| waitForXpathSelector_77
    waitForXpathSelector_77 -.->|"true"| waitForSelector_65
    waitForCssSelector_79 -->|"string & Brand&lt;'CssSel..."| createVisibilityCheckFunc_78
    createVisibilityCheckFunc_78 -.->|"CheckResult&lt;true"| waitForCssSelector_79
    waitForCssSelector_79 -->|"() =&gt; ResultAsync&lt;Chec..."| waitUntil_70
    waitUntil_70 -.->|"T"| waitForCssSelector_79
    waitForSelector_65 -->|"?"| waitForCssSelector_79
    waitForCssSelector_79 -.->|"true"| waitForSelector_65
    processWaitableSelector_63 -->|"WaitableSelectorSpec"| waitForSelector_65
    waitForSelector_65 -.->|"WaitResult"| processWaitableSelector_63
    processWaitableSelector_63 -->|"AgentBrowserError"| getErrorMessage_18
    getErrorMessage_18 -.->|"string"| processWaitableSelector_63
    processDirectOrWaitSelector_61 -->|"?"| processWaitableSelector_63
    processWaitableSelector_63 -.->|"ResolvedCommand"| processDirectOrWaitSelector_61
    processSelectorWait_58 -->|"?"| processDirectOrWaitSelector_61
    processDirectOrWaitSelector_61 -.->|"ResolvedCommand"| processSelectorWait_58
    extractWaitableSelectorSpecOrFail_81 -->|"Command"| extractSelectorSpec_60
    extractSelectorSpec_60 -.->|"ExtractSelectorResult"| extractWaitableSelectorSpecOrFail_81
    processSelectorWait_58 -->|"?"| extractWaitableSelectorSpecOrFail_81
    extractWaitableSelectorSpecOrFail_81 -.->|"WaitableSelectorSpec"| processSelectorWait_58
    processSelectorWait_58 -->|"?"| processWaitableSelector_63
    processWaitableSelector_63 -.->|"ResolvedCommand"| processSelectorWait_58
    executeStep_14 -->|"Command"| processSelectorWait_58
    processSelectorWait_58 -.->|"ResolvedCommand"| executeStep_14
    executeAllSteps_12 -->|"Command"| executeStep_14
    executeStep_14 -.->|"StepResult"| executeAllSteps_12
    executeAllSteps_12 -->|"Flow"| buildFailedFlowResult_10
    buildFailedFlowResult_10 -.->|"FailedFlowResult"| executeAllSteps_12
    executeFlow_7 -->|"Flow"| executeAllSteps_12
    executeAllSteps_12 -.->|"ExecuteAllStepsResult"| executeFlow_7
    executeSingleFlow_3 -->|"Flow"| executeFlow_7
    executeFlow_7 -.->|"FlowResult"| executeSingleFlow_3
    executeAllFlowsParallel_2 -->|"?"| executeSingleFlow_3
    executeSingleFlow_3 -.->|"FlowRunSummary"| executeAllFlowsParallel_2
    executeAllFlows_1 -->|"readonly Flow()"| executeAllFlowsParallel_2
    executeAllFlowsParallel_2 -.->|"RunFlowsOutput"| executeAllFlows_1
    executeAllFlowsSequential_93 -->|"Flow"| executeSingleFlow_3
    executeSingleFlow_3 -.->|"FlowRunSummary"| executeAllFlowsSequential_93
    executeAllFlows_1 -->|"readonly Flow()"| executeAllFlowsSequential_93
    executeAllFlowsSequential_93 -.->|"RunFlowsOutput"| executeAllFlows_1
    runFlows_0 -->|"?"| executeAllFlows_1
    executeAllFlows_1 -.->|"RunFlowsOutput"| runFlows_0
    resolveStepVariables_99 -->|"unknown"| isRecord_100
    isRecord_100 -.->|"boolean"| resolveStepVariables_99
    resolveObjectVariables_101 -->|"unknown"| isRecord_100
    isRecord_100 -.->|"boolean"| resolveObjectVariables_101
    resolveObjectVariables_101 -->|"Record&lt;string, unknown&gt;"| resolveObjectVariables_101
    resolveObjectVariables_101 -.->|"Result&lt;void, ParseError&gt;"| resolveObjectVariables_101
    resolveStepVariables_99 -->|"Record&lt;string, unknown&gt;"| resolveObjectVariables_101
    resolveObjectVariables_101 -.->|"Result&lt;void, ParseError&gt;"| resolveStepVariables_99
    resolveEnvVariables_97 -->|"?"| resolveStepVariables_99
    resolveStepVariables_99 -.->|"Result&lt;unknown, ParseE..."| resolveEnvVariables_97
    parseFlowYaml_96 -->|"?"| resolveEnvVariables_97
    resolveEnvVariables_97 -.->|"Result&lt;RawFlowData, Pa..."| parseFlowYaml_96
    extractEnvFromRoot_104 -->|"unknown"| isRecord_105
    isRecord_105 -.->|"boolean"| extractEnvFromRoot_104
    buildRawFlowData_103 -->|"Record&lt;string, unknown&gt;"| extractEnvFromRoot_104
    extractEnvFromRoot_104 -.->|"Readonly&lt;Record&lt;string..."| buildRawFlowData_103
    parseFlowYaml_96 -->|"?"| buildRawFlowData_103
    buildRawFlowData_103 -.->|"RawFlowData"| parseFlowYaml_96
    validateRootStructure_108 -->|"unknown"| isRecord_105
    isRecord_105 -.->|"boolean"| validateRootStructure_108
    parseFlowYaml_96 -->|"?"| validateRootStructure_108
    validateRootStructure_108 -.->|"Result&lt;Record&lt;string, ..."| parseFlowYaml_96
    appendValidatedCommand_114 -->|"unknown"| validateCommand_115
    validateCommand_115 -.->|"Result&lt;Command, ParseE..."| appendValidatedCommand_114
    reduceValidateCommand_113 -->|"?"| appendValidatedCommand_114
    appendValidatedCommand_114 -.->|"Result&lt;Command(), Pars..."| reduceValidateCommand_113
    validateAllCommands_112 -->|"?"| reduceValidateCommand_113
    reduceValidateCommand_113 -.->|"Result&lt;Command(), Pars..."| validateAllCommands_112
    validateCommands_111 -->|"?"| validateAllCommands_112
    validateAllCommands_112 -.->|"Result&lt;Command(), Pars..."| validateCommands_111
    buildFlow_110 -->|"unknown()"| validateCommands_111
    validateCommands_111 -.->|"Result&lt;readonly Comman..."| buildFlow_110
    parseFlowYaml_96 -->|"RawFlowData"| buildFlow_110
    buildFlow_110 -.->|"Result&lt;Flow, ParseError&gt;"| parseFlowYaml_96
    loadSingleFlow_95 -->|"?"| parseFlowYaml_96
    parseFlowYaml_96 -.->|"Result&lt;Flow, ParseError&gt;"| loadSingleFlow_95
    loadAllFlows_94 -->|"?"| loadSingleFlow_95
    loadSingleFlow_95 -.->|"Flow"| loadAllFlows_94
    runFlows_0 -->|"?"| loadAllFlows_94
    loadAllFlows_94 -.->|"readonly Flow()"| runFlows_0

    %% Subgraph styles
    style packages fill:#e8f4f8,stroke:#999
    style packages_core fill:#f0e8f8,stroke:#999
    style packages_core_src fill:#f8f0e8,stroke:#999