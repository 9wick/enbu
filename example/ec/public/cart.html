<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>カート - オンラインショップ</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Hiragino Sans', 'Meiryo', sans-serif; background: #f5f5f5; color: #333; }
    header { background: #2c3e50; color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
    header h1 { font-size: 1.5rem; }
    header a { color: white; text-decoration: none; }
    main { max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
    h2 { margin-bottom: 1.5rem; }
    .cart-container { display: grid; grid-template-columns: 1fr 300px; gap: 2rem; }
    @media (max-width: 768px) { .cart-container { grid-template-columns: 1fr; } }
    .cart-items { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; }
    .cart-item { display: grid; grid-template-columns: 80px 1fr auto; gap: 1rem; padding: 1rem; border-bottom: 1px solid #eee; align-items: center; }
    .cart-item:last-child { border-bottom: none; }
    .cart-item-image { width: 80px; height: 80px; object-fit: contain; background: #f9f9f9; border-radius: 4px; }
    .cart-item-info { }
    .cart-item-name { font-weight: bold; margin-bottom: 0.5rem; }
    .cart-item-price { color: #666; }
    .cart-item-actions { display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem; }
    .quantity-control { display: flex; align-items: center; gap: 0.5rem; }
    .quantity-btn { width: 30px; height: 30px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 1rem; }
    .quantity-btn:hover { background: #f5f5f5; }
    .quantity-btn:disabled { color: #ccc; cursor: not-allowed; }
    .quantity-value { width: 40px; text-align: center; font-weight: bold; }
    .cart-item-subtotal { font-weight: bold; color: #e74c3c; }
    .remove-btn { color: #e74c3c; background: none; border: none; cursor: pointer; font-size: 0.875rem; }
    .remove-btn:hover { text-decoration: underline; }
    .cart-empty { padding: 3rem; text-align: center; color: #666; }
    .cart-empty a { color: #3498db; }
    .cart-summary { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 1.5rem; height: fit-content; position: sticky; top: 2rem; }
    .cart-summary h3 { margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #eee; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 0.75rem; }
    .summary-total { font-size: 1.25rem; font-weight: bold; padding-top: 1rem; border-top: 2px solid #eee; margin-top: 1rem; }
    .summary-total .price { color: #e74c3c; }
    .btn { width: 100%; padding: 1rem; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer; margin-top: 1rem; }
    .btn-primary { background: #3498db; color: white; }
    .btn-primary:hover { background: #2980b9; }
    .btn-primary:disabled { background: #bdc3c7; cursor: not-allowed; }
    .btn-outline { background: white; color: #3498db; border: 2px solid #3498db; }
    .btn-outline:hover { background: #f0f8ff; }
    .toast { position: fixed; bottom: 2rem; right: 2rem; padding: 1rem 1.5rem; background: #27ae60; color: white; border-radius: 4px; opacity: 0; transition: opacity 0.3s; z-index: 1000; }
    .toast.show { opacity: 1; }
    .loading { text-align: center; padding: 3rem; }
  </style>
</head>
<body>
  <header>
    <h1><a href="index.html">オンラインショップ</a></h1>
  </header>

  <main>
    <h2>ショッピングカート</h2>

    <div id="cart-container" class="cart-container">
      <div class="loading">読み込み中...</div>
    </div>
  </main>

  <div class="toast" id="toast"></div>

  <script>
    let sessionId = localStorage.getItem('sessionId');
    let cartData = null;

    /** セッションヘッダー付きfetch */
    function fetchWithSession(url, options = {}) {
      const headers = { ...options.headers };
      if (sessionId) {
        headers['X-Session-Id'] = sessionId;
      }
      return fetch(url, { ...options, headers });
    }

    /** トースト表示 */
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    /** カートを読み込み */
    async function loadCart() {
      const response = await fetchWithSession('/api/cart');
      cartData = await response.json();
      renderCart();
    }

    /** カートを描画 */
    function renderCart() {
      const container = document.getElementById('cart-container');

      if (cartData.items.length === 0) {
        container.innerHTML = `
          <div class="cart-items">
            <div class="cart-empty">
              <p>カートは空です</p>
              <p><a href="index.html">商品一覧を見る</a></p>
            </div>
          </div>
        `;
        return;
      }

      const itemsHtml = cartData.items.map(item => `
        <div class="cart-item" data-product-id="${item.productId}">
          <img src="${item.product.image}" alt="${item.product.name}" class="cart-item-image">
          <div class="cart-item-info">
            <div class="cart-item-name">${item.product.name}</div>
            <div class="cart-item-price">¥${item.product.price.toLocaleString()} × ${item.quantity}</div>
          </div>
          <div class="cart-item-actions">
            <div class="quantity-control">
              <button class="quantity-btn" onclick="updateQuantity(${item.productId}, ${item.quantity - 1})" ${item.quantity <= 1 ? 'disabled' : ''}>−</button>
              <span class="quantity-value">${item.quantity}</span>
              <button class="quantity-btn" onclick="updateQuantity(${item.productId}, ${item.quantity + 1})" ${item.quantity >= item.product.stock ? 'disabled' : ''}>+</button>
            </div>
            <div class="cart-item-subtotal">¥${item.subtotal.toLocaleString()}</div>
            <button class="remove-btn" onclick="removeItem(${item.productId})">削除する</button>
          </div>
        </div>
      `).join('');

      const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');

      container.innerHTML = `
        <div class="cart-items">
          ${itemsHtml}
        </div>
        <div class="cart-summary">
          <h3>注文概要</h3>
          <div class="summary-row">
            <span>商品数</span>
            <span>${cartData.items.reduce((sum, item) => sum + item.quantity, 0)}点</span>
          </div>
          <div class="summary-row">
            <span>小計</span>
            <span>¥${cartData.total.toLocaleString()}</span>
          </div>
          <div class="summary-row">
            <span>送料</span>
            <span>${cartData.total >= 5000 ? '無料' : '¥500'}</span>
          </div>
          <div class="summary-row summary-total">
            <span>合計</span>
            <span class="price">¥${(cartData.total + (cartData.total >= 5000 ? 0 : 500)).toLocaleString()}</span>
          </div>
          ${currentUser ? `
            <a href="checkout.html" class="btn btn-primary" style="display: block; text-decoration: none; text-align: center;">レジに進む</a>
          ` : `
            <a href="login.html" class="btn btn-primary" style="display: block; text-decoration: none; text-align: center;">ログインして購入</a>
          `}
          <a href="index.html" class="btn btn-outline" style="display: block; text-decoration: none; text-align: center;">買い物を続ける</a>
        </div>
      `;
    }

    /** 数量を更新 */
    async function updateQuantity(productId, quantity) {
      if (quantity <= 0) {
        await removeItem(productId);
        return;
      }

      const response = await fetchWithSession(`/api/cart/${productId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ quantity })
      });

      if (response.ok) {
        await loadCart();
        showToast('数量を更新しました');
      } else {
        const error = await response.json();
        showToast(error.error || 'エラーが発生しました');
      }
    }

    /** 商品を削除 */
    async function removeItem(productId) {
      const response = await fetchWithSession(`/api/cart/${productId}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        await loadCart();
        showToast('商品を削除しました');
      } else {
        const error = await response.json();
        showToast(error.error || 'エラーが発生しました');
      }
    }

    // 初期化
    loadCart();
  </script>
</body>
</html>
